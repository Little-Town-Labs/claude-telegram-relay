# Implementation Plan: SecondBrain Integration

**Branch**: `002-secondbrain-integration` | **Date**: 2026-02-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-secondbrain-integration/spec.md`

## Summary

Port the SecondBrain knowledge management system from its Python/Discord/Ollama implementation into the TypeScript Telegram relay. Six new services (CaptureService, ScannerService, SynthesisService, DigestService, SchedulerService, FixerService) will be implemented using Claude CLI for AI operations, minimal local code for YAML frontmatter, and `setTimeout` for scheduling. The relay will be containerized in a Podman pod. All features are gated behind `SECONDBRAIN_ENABLED` to preserve core relay functionality.

## Technical Context

**Language/Version**: TypeScript 5.9+ on Node.js 18+
**Primary Dependencies**: grammy 1.21+, pino 9.5+, zod 3.24+ (no new deps)
**Storage**: Local markdown files with YAML frontmatter in `~/.claude-relay/secondbrain/`
**Testing**: vitest 4.0+ with mocked fs/promises, fake timers, spawn mocks
**Target Platform**: Linux container (Podman pod) or native host
**Project Type**: Single project (Node.js CLI daemon)
**Performance Goals**: Classification <10s, stats <2s, digest <30s
**Constraints**: <256MB RSS, no new npm deps, core loop unaffected
**Scale/Scope**: Single user, up to 1000 captures

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Code Quality First | PASS | Biome strict, TypeScript strict, Zod validation on Claude CLI JSON output |
| II. Test-First | PASS | Every new service gets tests before implementation |
| III. Testing Standards | PASS | All tests deterministic with mocked fs, timers, spawn |
| IV. UX Consistency | PASS | All commands return formatted Telegram messages, typing indicators |
| V. Performance | PASS | Classification via Claude CLI (spawn <2s overhead), scanner reads local files |
| VI. Security | PASS | User ID verified before any command, API key via env var not in logs |
| VII. Simplicity | PASS | No new deps. YAML via local code, git via spawn, scheduling via setTimeout |
| VIII. Observability | PASS | All services use pino logger with structured fields |
| IX. One Reliable Behavior | PASS | `/capture` is one action, system does classification + storage |
| X. Separation of Concerns | PASS | Each service has single responsibility, loosely coupled |
| XI. Contracts | PASS | TypeScript interfaces, Zod schemas for CLI output |
| XII. Trust Mechanisms | PASS | Confidence scores visible to user, inbox log audit trail |
| XIII. Safe Defaults | PASS | Fallback classification (admin/0.0) on error, feature disabled by default |
| XIV. Actionable Outputs | PASS | Digests formatted for Telegram, typing indicators during generation |
| XV. Next Action | PASS | Captured data has specific next_action fields, digests prioritize actions |
| XVI. Routing Over Organizing | PASS | System classifies automatically, user just sends `/capture <text>` |
| XVII. Minimal Interfaces | PASS | Config starts with minimum viable fields |
| XVIII. Design for Restart | PASS | File-based storage survives restart, scheduler recalculates on start |
| XIX. Core Loop First | PASS | SecondBrain gated behind enabled flag, core loop unchanged |
| XX. Maintainability | PASS | Direct code, well-known patterns, no clever abstractions |

## Project Structure

### Documentation (this feature)

```text
specs/002-secondbrain-integration/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Research decisions
├── data-model.md        # Entity definitions
├── quickstart.md        # Setup guide
├── contracts/
│   └── services.md      # Service interfaces
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── services/
│   ├── capture.ts          # NEW: Classify + store thoughts
│   ├── scanner.ts          # NEW: Read markdown files
│   ├── synthesis.ts        # NEW: Prioritize + summarize
│   ├── digest.ts           # NEW: Generate digests via Claude CLI
│   ├── scheduler.ts        # NEW: Timer-based scheduling
│   ├── fixer.ts            # NEW: Reclassify captures
│   ├── claude.ts           # EXISTING: CLI spawn (reused by CaptureService, DigestService)
│   ├── session.ts          # EXISTING: Session persistence (unchanged)
│   ├── memory.ts           # EXISTING: Facts/goals (unchanged)
│   ├── media.ts            # EXISTING: Photo/document handlers (unchanged)
│   └── index.ts            # MODIFIED: Add new service exports
├── utils/
│   ├── frontmatter.ts      # NEW: YAML frontmatter parse/serialize
│   ├── queue.ts             # EXISTING: MessageQueue (unchanged)
│   ├── logger.ts            # EXISTING: Pino logger (unchanged)
│   ├── lock.ts              # EXISTING: Lock manager (unchanged)
│   ├── telegram.ts          # EXISTING: Send helpers (unchanged)
│   └── index.ts             # MODIFIED: Add frontmatter export
├── types/
│   ├── secondbrain.ts       # NEW: SecondBrain types
│   ├── config.ts            # MODIFIED: Add SecondBrainConfig
│   ├── session.ts           # EXISTING: (unchanged)
│   ├── memory.ts            # EXISTING: (unchanged)
│   └── index.ts             # MODIFIED: Re-export secondbrain types
├── config/
│   ├── schema.ts            # MODIFIED: Add secondbrain config section
│   └── index.ts             # EXISTING: (unchanged)
├── prompts/
│   ├── classify.txt         # NEW: Classification prompt
│   ├── daily_digest.txt     # NEW: Daily digest template
│   └── weekly_review.txt    # NEW: Weekly review template
├── index.ts                 # MODIFIED: Wire SecondBrain commands
└── relay.ts                 # EXISTING: NEVER MODIFIED (FR-013)

tests/
├── unit/
│   ├── services/
│   │   ├── capture.test.ts      # NEW
│   │   ├── scanner.test.ts      # NEW
│   │   ├── synthesis.test.ts    # NEW
│   │   ├── digest.test.ts       # NEW
│   │   ├── scheduler.test.ts    # NEW
│   │   ├── fixer.test.ts        # NEW
│   │   ├── claude.test.ts       # EXISTING
│   │   ├── session.test.ts      # EXISTING
│   │   └── memory.test.ts       # EXISTING
│   └── utils/
│       ├── frontmatter.test.ts  # NEW
│       └── queue.test.ts        # EXISTING
└── integration/
    ├── relay.test.ts            # EXISTING
    └── secondbrain.test.ts      # NEW

infrastructure/
├── Containerfile               # NEW
├── podman-setup.sh             # NEW
├── podman-manage.sh            # NEW
└── .env.example                # NEW
```

**Structure Decision**: Single project structure, extending existing `src/services/` pattern. New SecondBrain services follow the same constructor injection, pino logging, and error-string-return patterns established in spec-001.

## Complexity Tracking

No constitution violations to justify. All gates pass.

## Phase Summary

| Phase | Focus | New Files | Modified Files | Estimated Tests |
|-------|-------|-----------|----------------|-----------------|
| 1 | Types, Config, Frontmatter | 3 | 3 | ~15 |
| 2 | CaptureService | 2 | 0 | ~15 |
| 3 | ScannerService | 2 | 0 | ~12 |
| 4 | SynthesisService | 2 | 0 | ~10 |
| 5 | DigestService + Prompts | 5 | 0 | ~8 |
| 6 | SchedulerService | 2 | 0 | ~8 |
| 7 | FixerService | 2 | 0 | ~10 |
| 8 | Telegram Integration | 0 | 2 | ~6 |
| 9 | Container Infrastructure | 4 | 0 | ~2 (manual) |
| 10 | Polish & Integration Tests | 1 | 0 | ~8 |
| **Total** | | **23** | **5** | **~104** |

## Verification

1. **Unit tests**: `npm test` — all existing 111 + new ~104 tests pass
2. **Type check**: `npm run typecheck` — clean
3. **Lint**: `npm run lint` — clean (Biome strict mode)
4. **Capture flow**: `/capture Had a call with Sarah` → verify file in `People/` with frontmatter
5. **Stats**: `/stats` → verify counts match files on disk
6. **Digest**: `/digest` → verify formatted response within 30s
7. **Fix**: `/capture` then `/fix projects` → verify file moved
8. **Core loop**: Regular text message → normal Claude response (no SecondBrain interference)
9. **Disabled**: Set `SECONDBRAIN_ENABLED=false` → `/capture` replies "SecondBrain is not enabled"
10. **Container**: `podman pod start` → bot responds to messages
